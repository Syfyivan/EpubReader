# ä¸´æ—¶é«˜äº®åŠŸèƒ½æµ‹è¯•æŒ‡å— (2025-11-10)

## ä¿®å¤å†…å®¹

é’ˆå¯¹"ä¸´æ—¶é«˜äº®ä¿æŒæ˜¾ç¤ºç›´åˆ°ç‚¹å‡»åˆ’çº¿æˆ–å–æ¶ˆ"çš„åŠŸèƒ½é—®é¢˜ï¼Œè¿›è¡Œäº†ä»¥ä¸‹ä¿®å¤ï¼š

### 1. ä¿®å¤æ—¶åºé—®é¢˜

**é—®é¢˜**ï¼šé€‰ä¸­æ–‡æœ¬åï¼Œä¸´æ—¶é«˜äº®æ²¡æœ‰æ˜¾ç¤ºï¼Œåªèƒ½çœ‹åˆ°æµè§ˆå™¨é»˜è®¤çš„é€‰ä¸­æ•ˆæœã€‚

**åŸå› **ï¼šåˆ›å»ºä¸´æ—¶é«˜äº®åï¼Œæµè§ˆå™¨çš„ selection æ²¡æœ‰è¢«æ¸…é™¤ï¼Œå¯¼è‡´è“è‰²é€‰ä¸­æ•ˆæœè¦†ç›–äº†ä¸´æ—¶é«˜äº®ã€‚

**ä¿®å¤**ï¼š
```typescript
// ä½¿ç”¨ requestAnimationFrame ç¡®ä¿æ—¶åºæ­£ç¡®
requestAnimationFrame(() => {
  createTempHighlight(range);  // å…ˆåˆ›å»ºä¸´æ—¶é«˜äº®
  window.getSelection()?.removeAllRanges();  // ç«‹å³æ¸…é™¤æµè§ˆå™¨é€‰æ‹©
  console.log('ğŸ¨ å·²åˆ›å»ºä¸´æ—¶é«˜äº®å¹¶æ¸…é™¤é€‰æ‹©');
});
```

### 2. å¢å¼ºé”™è¯¯å¤„ç†å’Œæ—¥å¿—

åœ¨ `createTempHighlight` å‡½æ•°ä¸­æ·»åŠ äº†æ›´å¤šçš„æ—¥å¿—è¾“å‡ºï¼Œä¾¿äºè°ƒè¯•ï¼š
- è®°å½•åˆ›å»ºä¸´æ—¶é«˜äº®æ—¶çš„æ–‡æœ¬å†…å®¹
- æ£€æŸ¥ä¸´æ—¶é«˜äº®æ˜¯å¦æˆåŠŸæ·»åŠ åˆ° DOM
- è¯¦ç»†è®°å½•å¤‡ç”¨æ–¹æ³•çš„æ‰§è¡Œæƒ…å†µ

### 3. ä¼˜åŒ– CSS æ ·å¼

å¢å¼ºäº†ä¸´æ—¶é«˜äº®çš„è§†è§‰æ•ˆæœï¼š
```css
.temp-highlight {
  background-color: rgba(59, 130, 246, 0.3) !important;  /* æ›´æ˜æ˜¾çš„èƒŒæ™¯è‰² */
  border-radius: 3px !important;
  padding: 2px 0 !important;
  animation: pulseHighlight 1.5s ease-in-out infinite !important;
  position: relative !important;
  z-index: 10 !important;  /* ç¡®ä¿åœ¨æœ€ä¸Šå±‚æ˜¾ç¤º */
}

@keyframes pulseHighlight {
  0%, 100% {
    background-color: rgba(59, 130, 246, 0.3);
  }
  50% {
    background-color: rgba(59, 130, 246, 0.45);  /* æ›´å¼ºçš„å‘¼å¸æ•ˆæœ */
  }
}
```

## æµ‹è¯•æ­¥éª¤

### åŸºæœ¬åŠŸèƒ½æµ‹è¯•

1. **å•è¡Œæ–‡æœ¬é€‰æ‹©**
   - åœ¨ç« èŠ‚å†…å®¹ä¸­é€‰æ‹©ä¸€è¡Œæ–‡å­—
   - æ¾å¼€é¼ æ ‡
   - é¢„æœŸï¼š
     - âœ… æ˜¾ç¤º"åˆ’çº¿"æŒ‰é’® tooltip
     - âœ… é€‰ä¸­çš„æ–‡å­—æœ‰æ·¡è“è‰²èƒŒæ™¯é«˜äº®
     - âœ… é«˜äº®æœ‰å¾®å¦™çš„å‘¼å¸åŠ¨ç”»ï¼ˆæ˜æš—å˜åŒ–ï¼‰
     - âœ… æµè§ˆå™¨é»˜è®¤çš„è“è‰²é€‰ä¸­æ•ˆæœæ¶ˆå¤±

2. **å¤šè¡Œæ–‡æœ¬é€‰æ‹©**
   - é€‰æ‹©è·¨è¶Š2-3è¡Œçš„æ–‡å­—
   - æ¾å¼€é¼ æ ‡
   - é¢„æœŸï¼š
     - âœ… æ‰€æœ‰é€‰ä¸­çš„æ–‡å­—éƒ½æœ‰ä¸´æ—¶é«˜äº®
     - âœ… tooltip æ˜¾ç¤ºåœ¨ç¬¬ä¸€è¡Œä¸Šæ–¹ä¸­é—´ä½ç½®

3. **è·¨æ®µè½é€‰æ‹©**
   - é€‰æ‹©è·¨è¶Šå¤šä¸ªæ®µè½çš„æ–‡å­—
   - æ¾å¼€é¼ æ ‡
   - é¢„æœŸï¼š
     - âœ… æ‰€æœ‰é€‰ä¸­çš„æ–‡å­—éƒ½æœ‰ä¸´æ—¶é«˜äº®
     - âœ… æ§åˆ¶å°æ˜¾ç¤º "âœ… ä½¿ç”¨å¤‡ç”¨æ–¹æ³•åˆ›å»ºä¸´æ—¶é«˜äº®å±‚"

### æŒä¹…æ€§æµ‹è¯•

4. **ä¸´æ—¶é«˜äº®ä¿æŒæ˜¾ç¤º**
   - é€‰æ‹©ä¸€æ®µæ–‡å­—ï¼Œè§‚å¯Ÿä¸´æ—¶é«˜äº®
   - å°†é¼ æ ‡ç§»åˆ° tooltip ä¸Š
   - é¢„æœŸï¼š
     - âœ… ä¸´æ—¶é«˜äº®ç»§ç»­æ˜¾ç¤ºï¼ˆä¸æ¶ˆå¤±ï¼‰
     - âœ… å‘¼å¸åŠ¨ç”»ç»§ç»­

5. **ç‚¹å‡»å…¶ä»–åœ°æ–¹å–æ¶ˆ**
   - é€‰æ‹©ä¸€æ®µæ–‡å­—
   - ç‚¹å‡»ç©ºç™½åŒºåŸŸ
   - é¢„æœŸï¼š
     - âœ… ä¸´æ—¶é«˜äº®æ¶ˆå¤±
     - âœ… tooltip æ¶ˆå¤±
     - âœ… æ§åˆ¶å°æ— é”™è¯¯

6. **åˆ›å»ºæ­£å¼åˆ’çº¿**
   - é€‰æ‹©ä¸€æ®µæ–‡å­—
   - ç‚¹å‡»"åˆ’çº¿"æŒ‰é’®
   - é¢„æœŸï¼š
     - âœ… ä¸´æ—¶é«˜äº®æ¶ˆå¤±
     - âœ… å‡ºç°è“è‰²ä¸‹åˆ’çº¿ï¼ˆæ­£å¼åˆ’çº¿ï¼‰
     - âœ… åˆ’çº¿å‡ºç°åœ¨ä¾§è¾¹æ åˆ—è¡¨ä¸­

### è¾¹ç•Œæƒ…å†µæµ‹è¯•

7. **åŒ…å«é“¾æ¥çš„æ–‡æœ¬**
   - é€‰æ‹©åŒ…å«é“¾æ¥çš„æ–‡å­—
   - è§‚å¯Ÿä¸´æ—¶é«˜äº®
   - é¢„æœŸï¼š
     - âœ… é“¾æ¥æ–‡å­—ä¹Ÿè¢«é«˜äº®
     - âœ… æ§åˆ¶å°å¯èƒ½æ˜¾ç¤ºä½¿ç”¨å¤‡ç”¨æ–¹æ³•

8. **é‡å¤é€‰æ‹©**
   - é€‰æ‹©æ–‡å­— Aï¼Œè§‚å¯Ÿä¸´æ—¶é«˜äº®
   - ä¸ç‚¹å‡»åˆ’çº¿ï¼Œç›´æ¥é€‰æ‹©æ–‡å­— B
   - é¢„æœŸï¼š
     - âœ… æ–‡å­— A çš„ä¸´æ—¶é«˜äº®æ¶ˆå¤±
     - âœ… æ–‡å­— B æ˜¾ç¤ºæ–°çš„ä¸´æ—¶é«˜äº®

9. **åˆ‡æ¢ç« èŠ‚**
   - é€‰æ‹©æ–‡å­—ï¼Œè§‚å¯Ÿä¸´æ—¶é«˜äº®
   - åˆ‡æ¢åˆ°å…¶ä»–ç« èŠ‚
   - é¢„æœŸï¼š
     - âœ… ä¸´æ—¶é«˜äº®æ¶ˆå¤±
     - âœ… æ–°ç« èŠ‚æ²¡æœ‰ä¸´æ—¶é«˜äº®

## è°ƒè¯•æŒ‡å—

### æ§åˆ¶å°æ—¥å¿—

æ­£å¸¸æµç¨‹åº”è¯¥çœ‹åˆ°ä»¥ä¸‹æ—¥å¿—ï¼š

```
âœ… ä¿å­˜é€‰ä¸­èŒƒå›´ï¼Œæ–‡æœ¬: [é€‰ä¸­çš„æ–‡æœ¬å‰30ä¸ªå­—ç¬¦]
âœ… åˆ›å»ºä¸´æ—¶é«˜äº®å±‚ï¼Œæ–‡æœ¬: [é€‰ä¸­çš„æ–‡æœ¬å‰30ä¸ªå­—ç¬¦]
ğŸ¨ å·²åˆ›å»ºä¸´æ—¶é«˜äº®å¹¶æ¸…é™¤é€‰æ‹©
```

æˆ–è€…ï¼ˆå¯¹äºå¤æ‚é€‰æ‹©ï¼‰ï¼š

```
âœ… ä¿å­˜é€‰ä¸­èŒƒå›´ï¼Œæ–‡æœ¬: [é€‰ä¸­çš„æ–‡æœ¬å‰30ä¸ªå­—ç¬¦]
âš ï¸ surroundContents å¤±è´¥ï¼Œä½¿ç”¨å¤‡ç”¨æ–¹æ³•
âœ… ä½¿ç”¨å¤‡ç”¨æ–¹æ³•åˆ›å»ºä¸´æ—¶é«˜äº®å±‚
âœ… ä¸´æ—¶é«˜äº®å·²æ·»åŠ åˆ° DOM
ğŸ¨ å·²åˆ›å»ºä¸´æ—¶é«˜äº®å¹¶æ¸…é™¤é€‰æ‹©
```

### å¸¸è§é—®é¢˜

**é—®é¢˜ 1ï¼šä¸´æ—¶é«˜äº®æ²¡æœ‰æ˜¾ç¤º**
- æ£€æŸ¥æ§åˆ¶å°æ˜¯å¦æœ‰é”™è¯¯
- æ£€æŸ¥æ˜¯å¦æœ‰ "âŒ åˆ›å»ºä¸´æ—¶é«˜äº®å±‚å¤±è´¥" çš„æ—¥å¿—
- ä½¿ç”¨æµè§ˆå™¨å¼€å‘è€…å·¥å…·æ£€æŸ¥ DOMï¼ŒæŸ¥æ‰¾ `.temp-highlight` å…ƒç´ 

**é—®é¢˜ 2ï¼šä¸´æ—¶é«˜äº®ç«‹å³æ¶ˆå¤±**
- æ£€æŸ¥æ˜¯å¦æœ‰å…¶ä»–ä»£ç æ¸…é™¤äº†ä¸´æ—¶é«˜äº®
- æ£€æŸ¥ MutationObserver æ˜¯å¦è§¦å‘äº†é‡æ–°æ¸²æŸ“

**é—®é¢˜ 3ï¼šä¸´æ—¶é«˜äº®ä¸å¤Ÿæ˜æ˜¾**
- æ£€æŸ¥ CSS æ ·å¼æ˜¯å¦è¢«æ­£ç¡®åº”ç”¨
- åœ¨å¼€å‘è€…å·¥å…·ä¸­æ£€æŸ¥ `.temp-highlight` å…ƒç´ çš„è®¡ç®—æ ·å¼
- è°ƒæ•´ CSS ä¸­çš„èƒŒæ™¯è‰²é€æ˜åº¦

**é—®é¢˜ 4ï¼šåŠ¨ç”»ä¸æµç•…**
- æ£€æŸ¥ CSS åŠ¨ç”»æ˜¯å¦è¢«ç¦ç”¨
- æ£€æŸ¥æµè§ˆå™¨æ€§èƒ½è®¾ç½®

## è§†è§‰å¯¹æ¯”

| çŠ¶æ€ | å¤–è§‚ | æŒç»­æ—¶é—´ |
|------|------|---------|
| æµè§ˆå™¨é»˜è®¤é€‰ä¸­ | çº¯è“è‰²èƒŒæ™¯ï¼Œæ— åŠ¨ç”» | å–æ¶ˆé€‰æ‹©åç«‹å³æ¶ˆå¤± |
| **ä¸´æ—¶é«˜äº®** | **æ·¡è“è‰²èƒŒæ™¯ + å‘¼å¸åŠ¨ç”»** | **ä¿æŒæ˜¾ç¤ºç›´åˆ°ç‚¹å‡»åˆ’çº¿æˆ–å–æ¶ˆ** |
| æ­£å¼åˆ’çº¿ | è“è‰²ä¸‹åˆ’çº¿ï¼Œæ— èƒŒæ™¯ | æ°¸ä¹…ä¿å­˜ |

## æŠ€æœ¯ç»†èŠ‚

### åˆ›å»ºä¸´æ—¶é«˜äº®çš„ä¸¤ç§æ–¹æ³•

1. **ç®€å•æ–¹æ³•**ï¼ˆå•ä¸ªæ–‡æœ¬èŠ‚ç‚¹å†…ï¼‰ï¼š
   ```typescript
   clonedRange.surroundContents(tempSpan);
   ```

2. **å¤æ‚æ–¹æ³•**ï¼ˆè·¨å¤šä¸ªèŠ‚ç‚¹ï¼‰ï¼š
   ```typescript
   const fragment = clonedRange.extractContents();
   tempSpan.appendChild(fragment);
   clonedRange.insertNode(tempSpan);
   ```

### æ¸…é™¤ä¸´æ—¶é«˜äº®

```typescript
const tempHighlights = contentRef.current?.querySelectorAll('.temp-highlight');
tempHighlights?.forEach(el => {
  const parent = el.parentNode;
  if (parent) {
    // å°†é«˜äº®å…ƒç´ çš„æ–‡æœ¬å†…å®¹æ¢å¤åˆ°çˆ¶èŠ‚ç‚¹
    while (el.firstChild) {
      parent.insertBefore(el.firstChild, el);
    }
    parent.removeChild(el);
  }
});
```

## åç»­ä¼˜åŒ–å»ºè®®

1. å¯ä»¥æ·»åŠ ä¸åŒé¢œè‰²çš„ä¸´æ—¶é«˜äº®ï¼ˆè®©ç”¨æˆ·é€‰æ‹©ï¼‰
2. å¯ä»¥è°ƒæ•´å‘¼å¸åŠ¨ç”»çš„é€Ÿåº¦
3. å¯ä»¥æ·»åŠ æ·¡å…¥æ·¡å‡ºæ•ˆæœ
4. å¯ä»¥åœ¨ä¸´æ—¶é«˜äº®ä¸Šæ˜¾ç¤ºé¢„è§ˆçš„åˆ’çº¿æ ·å¼

## ç›¸å…³æ–‡ä»¶

- `src/read/Read.tsx` - ä¸»è¦é€»è¾‘
- `src/read/Read.css` - ä¸´æ—¶é«˜äº®æ ·å¼

