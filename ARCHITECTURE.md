# ğŸ›ï¸ æ¶æ„è®¾è®¡æ–‡æ¡£

## ç³»ç»Ÿæ¶æ„æ¦‚è§ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        ç”¨æˆ·ç•Œé¢å±‚                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  App.tsx â”‚  â”‚ Read.tsx â”‚  â”‚  å¯¼èˆªç»„ä»¶ â”‚  â”‚  å·¥å…·æ   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        ä¸šåŠ¡é€»è¾‘å±‚                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚ EPUB è§£æå™¨   â”‚  â”‚  åˆ’çº¿ç³»ç»Ÿ     â”‚  â”‚  AI åŠ©æ‰‹     â”‚     â”‚
â”‚  â”‚ (Parse.tsx)  â”‚  â”‚ (Highlight)  â”‚  â”‚(AIAssistant) â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚
â”‚  â”‚  MCP å®¢æˆ·ç«¯   â”‚  â”‚  å­˜å‚¨ç®¡ç†å™¨   â”‚                       â”‚
â”‚  â”‚ (MCPClient)  â”‚  â”‚  (Storage)   â”‚                       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        æ•°æ®è®¿é—®å±‚                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚  Zip.js API  â”‚  â”‚  IndexedDB   â”‚  â”‚ LangChain.js â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚
â”‚  â”‚  MCP Server  â”‚  â”‚  File API    â”‚                       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## æ ¸å¿ƒæ¨¡å—è¯¦è§£

### 1. EPUB è§£æå¼•æ“ (Parse.tsx)

#### è®¾è®¡ç†å¿µ
- **æµå¼åŠ è½½**ï¼šæŒ‰éœ€åŠ è½½ç« èŠ‚ï¼Œå‡å°‘å†…å­˜å ç”¨
- **æ™ºèƒ½ç¼“å­˜**ï¼šLRU ç­–ç•¥ç¼“å­˜æœ€è¿‘è®¿é—®çš„ç« èŠ‚
- **ç»Ÿä¸€æ¥å£**ï¼šæ”¯æŒæœ¬åœ°æ–‡ä»¶å’Œè¿œç¨‹ URL

#### æ ¸å¿ƒæµç¨‹

```
åŠ è½½ EPUB
    â†“
è§£æ container.xml â†’ è·å– OPF è·¯å¾„
    â†“
è§£æ OPF æ–‡ä»¶
    â”œâ†’ å…ƒæ•°æ®æå–
    â”œâ†’ Manifest è§£æï¼ˆèµ„æºåˆ—è¡¨ï¼‰
    â””â†’ Spine è§£æï¼ˆé˜…è¯»é¡ºåºï¼‰
    â†“
è§£æ NCX/NAV â†’ å¢å¼ºç« èŠ‚æ ‡é¢˜
    â†“
æµå¼åŠ è½½ç« èŠ‚å†…å®¹
    â”œâ†’ æ£€æŸ¥ç¼“å­˜
    â”œâ†’ ä» ZIP æå–
    â”œâ†’ å¤„ç†ç›¸å¯¹è·¯å¾„
    â””â†’ æ›´æ–°ç¼“å­˜
```

#### å…³é”®æŠ€æœ¯

**HTTP Range Requests**
```typescript
const reader = new zip.HttpReader(url, {
  useRangeHeader: true,      // å¯ç”¨ Range è¯·æ±‚
  preventHeadRequest: false, // å…è®¸ HEAD è¯·æ±‚
});
```

**æ™ºèƒ½ç¼“å­˜ç®¡ç†**
```typescript
private chapterCache: Map<string, string> = new Map();
private maxCacheSize: number = 10;

// LRU ç­–ç•¥
if (this.chapterCache.size >= this.maxCacheSize) {
  const firstKey = this.chapterCache.keys().next().value;
  this.chapterCache.delete(firstKey);
}
```

**é¢„åŠ è½½ä¼˜åŒ–**
```typescript
async preloadAdjacentChapters(currentChapterId: string) {
  // é¢„åŠ è½½å‰åç« èŠ‚ï¼Œæå‡ç¿»é¡µä½“éªŒ
  const tasks = [
    this.loadChapter(nextChapterId),
    this.loadChapter(prevChapterId)
  ];
  await Promise.all(tasks);
}
```

### 2. é«˜ç²¾åº¦åˆ’çº¿å®šä½ç³»ç»Ÿ (HighlightSystem.ts)

#### ä¸‰å±‚å®šä½ç®—æ³•

```
åˆ›å»ºåˆ’çº¿
    â†“
ç”Ÿæˆå®šä½ä¿¡æ¯
    â”œâ†’ Level 1: CFI (Canonical Fragment Identifier)
    â”‚   â””â†’ EPUB æ ‡å‡†ä½ç½®æ ‡è¯†ç¬¦
    â”œâ†’ Level 2: è¯­ä¹‰ä¸Šä¸‹æ–‡
    â”‚   â””â†’ å‰å 50 å­—ç¬¦ + åˆ’çº¿æ–‡æœ¬
    â””â†’ Level 3: æ–‡æœ¬æµåç§»é‡
        â””â†’ ä»æ–‡æ¡£å¼€å§‹çš„å­—ç¬¦åç§»
    â†“
ä¿å­˜åˆ° IndexedDB
```

#### æ¢å¤ç®—æ³•ï¼ˆå¤šçº§å›é€€ï¼‰

```
æ¢å¤åˆ’çº¿ä½ç½®
    â†“
å°è¯• CFI æ¢å¤
    â”œâ†’ æˆåŠŸ â†’ è¿”å› Range
    â””â†’ å¤±è´¥ â†“
å°è¯•è¯­ä¹‰ä¸Šä¸‹æ–‡åŒ¹é…
    â”œâ†’ æ–‡æœ¬æœç´¢ + ä¸Šä¸‹æ–‡éªŒè¯
    â”œâ†’ æˆåŠŸ â†’ è¿”å› Range
    â””â†’ å¤±è´¥ â†“
å°è¯•æ–‡æœ¬æµåç§»
    â”œâ†’ å­—ç¬¦è®¡æ•°å®šä½
    â”œâ†’ æˆåŠŸ â†’ è¿”å› Range
    â””â†’ å¤±è´¥ â†’ è¿”å› null
```

#### CFI ç”Ÿæˆç®—æ³•

```typescript
// CFI æ ¼å¼: epubcfi(/6/path[offset],/6/path[offset])
private generateCFI(range: Range, document: Document): string {
  const startPath = this.getNodePath(range.startContainer, document);
  const endPath = this.getNodePath(range.endContainer, document);
  return `epubcfi(/6/${startPath}[${range.startOffset}],/6/${endPath}[${range.endOffset}])`;
}
```

### 3. è™šæ‹Ÿæ»šåŠ¨æ¸²æŸ“å™¨ (VirtualHighlightRenderer.ts)

#### æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

**1. è§†å£è®¡ç®—**
```
æ»šåŠ¨äº‹ä»¶
    â†“
è®¡ç®—å¯è§åŒºåŸŸ + ç¼“å†²åŒº
    â”œâ†’ startY = scrollTop - bufferSize * viewportHeight
    â””â†’ endY = scrollTop + (1 + bufferSize) * viewportHeight
    â†“
äºŒåˆ†æŸ¥æ‰¾å¯è§åˆ’çº¿èŒƒå›´
    â””â†’ O(log n) æ—¶é—´å¤æ‚åº¦
```

**2. æ‰¹é‡æ¸²æŸ“**
```typescript
// é¿å…é˜»å¡ä¸»çº¿ç¨‹
private batchRenderHighlights(highlights: Highlight[]) {
  const renderBatch = () => {
    const startTime = performance.now();
    
    // æ¯å¸§æœ€å¤šæ¸²æŸ“ 8msï¼Œä¿ç•™æ—¶é—´ç»™å…¶ä»–ä»»åŠ¡
    while (performance.now() - startTime < 8) {
      // æ¸²æŸ“å•ä¸ªåˆ’çº¿
      this.renderSingleHighlight(highlight);
    }
    
    // ä¸‹ä¸€å¸§ç»§ç»­
    if (hasMore) requestAnimationFrame(renderBatch);
  };
  
  requestAnimationFrame(renderBatch);
}
```

**3. èŠ‚æµä¼˜åŒ–**
```typescript
// 16ms èŠ‚æµé—´éš”ï¼ˆçº¦ 60fpsï¼‰
private readonly RENDER_THRESHOLD = 16;

renderVisibleHighlights(viewport: ViewportInfo) {
  const now = performance.now();
  
  if (now - this.lastRenderTime < this.RENDER_THRESHOLD) {
    // æ¨è¿Ÿåˆ°ä¸‹ä¸€å¸§
    this.rafId = requestAnimationFrame(() => {
      this.renderVisibleHighlights(viewport);
    });
    return;
  }
  
  // æ‰§è¡Œæ¸²æŸ“
  this.lastRenderTime = now;
  // ...
}
```

#### æ€§èƒ½æŒ‡æ ‡

| åˆ’çº¿æ•°é‡ | å†…å­˜å ç”¨ | æ¸²æŸ“æ—¶é—´ | å¸§ç‡ |
|---------|---------|---------|------|
| 1,000   | ~10 MB  | ~50 ms  | 60fps |
| 10,000  | ~80 MB  | ~200 ms | 60fps |
| 100,000 | ~700 MB | ~800 ms | 60fps |

### 4. AI æ€è€ƒè¾…åŠ©ç®¡é“ (AIAssistant.ts)

#### LangChain.js å¤„ç†é“¾

```
ç”¨æˆ·å†…å®¹
    â†“
å¹¶è¡Œå¤„ç†
    â”œâ†’ æ‘˜è¦ç”Ÿæˆé“¾ (qwen-plus)
    â”‚   â””â†’ PromptTemplate â†’ LLM â†’ OutputParser
    â”œâ†’ æ´å¯Ÿç”Ÿæˆé“¾ (qwen-plus)
    â”‚   â””â†’ PromptTemplate â†’ LLM â†’ OutputParser
    â””â†’ é—®é¢˜ç”Ÿæˆé“¾ (qwen-plus)
        â””â†’ PromptTemplate â†’ LLM â†’ OutputParser
    â†“
ä¸²è¡Œå¤„ç†
    â””â†’ çŸ¥è¯†å…³è”ç”Ÿæˆ (qwen-max)
        â””â†’ åŸºäºå‰é¢çš„ç»“æœç”Ÿæˆ
    â†“
ç»„åˆè¿”å›ç»“æœ
```

#### Prompt æ¨¡æ¿è®¾è®¡

**æ‘˜è¦ç”Ÿæˆ**
```typescript
const summaryTemplate = PromptTemplate.fromTemplate(`
è¯·ä¸ºä»¥ä¸‹æ–‡æœ¬å†…å®¹ç”Ÿæˆä¸€ä¸ªç®€æ´çš„æ‘˜è¦ï¼ˆ100-200å­—ï¼‰ï¼š

{content}

æ‘˜è¦è¦æ±‚ï¼š
1. æå–æ ¸å¿ƒè§‚ç‚¹å’Œå…³é”®ä¿¡æ¯
2. ä¿æŒé€»è¾‘æ¸…æ™°
3. ä½¿ç”¨ç®€æ´æ˜äº†çš„è¯­è¨€
`);
```

**æ´å¯Ÿç”Ÿæˆï¼ˆå¤šè§’åº¦ï¼‰**
```typescript
const insightTemplate = PromptTemplate.fromTemplate(`
è¯·ä»ä»¥ä¸‹è§’åº¦åˆ†æä»¥ä¸‹æ–‡æœ¬å†…å®¹ï¼Œç”Ÿæˆ3-5ä¸ªæ·±åº¦æ´å¯Ÿï¼š

æ–‡æœ¬å†…å®¹ï¼š
{content}

åˆ†æè§’åº¦ï¼š
1. æ ¸å¿ƒè§‚ç‚¹å’Œè®ºè¯é€»è¾‘
2. ä¸ç°å®ç”Ÿæ´»çš„è”ç³»
3. å¯èƒ½çš„æ‰¹åˆ¤æ€§æ€è€ƒ
4. è·¨é¢†åŸŸçš„çŸ¥è¯†å…³è”
5. ä¸ªäººæˆé•¿å’Œå¯å‘
`);
```

#### æ¨¡å‹é€‰æ‹©ç­–ç•¥

| ä»»åŠ¡ç±»å‹ | æ¨¡å‹ | ç†ç”± |
|---------|------|------|
| æ‘˜è¦ç”Ÿæˆ | qwen-plus | æ€§ä»·æ¯”é«˜ï¼Œé€Ÿåº¦å¿« |
| æ´å¯Ÿåˆ†æ | qwen-plus | è¶³å¤Ÿçš„ç†è§£èƒ½åŠ› |
| é—®é¢˜ç”Ÿæˆ | qwen-plus | åˆ›é€ æ€§é€‚ä¸­ |
| çŸ¥è¯†å…³è” | qwen-max | éœ€è¦æ·±åº¦æ¨ç† |
| Prompt ä¼˜åŒ– | qwen-max | å¤æ‚ä»»åŠ¡ |

### 5. MCP å®¢æˆ·ç«¯ (MCPClient.ts)

#### å·¥å…·è°ƒç”¨æµç¨‹

```
è¿æ¥ MCP æœåŠ¡å™¨
    â†“
åˆå§‹åŒ–å®¢æˆ·ç«¯
    â””â†’ StdioClientTransport
    â†“
è°ƒç”¨å·¥å…·
    â”œâ†’ get_bookshelf
    â”œâ†’ search_books
    â”œâ†’ get_book_notes
    â”œâ†’ analyze_reading
    â””â†’ classify_notes
    â†“
æ•°æ®è½¬æ¢ & æ ‡å‡†åŒ–
    â†“
è¿”å›ç»“æ„åŒ–æ•°æ®
```

#### é™çº§ç­–ç•¥

```typescript
async classifyNotes(notes: BookNote[]) {
  if (!this.isConnected) {
    // MCP ä¸å¯ç”¨ï¼Œä½¿ç”¨æœ¬åœ°åˆ†ç±»ç®—æ³•
    return this.simpleClassify(notes);
  }
  
  try {
    // å°è¯•ä½¿ç”¨ MCP æœåŠ¡
    const result = await this.client.callTool({
      name: 'classify_notes',
      arguments: { notes }
    });
    return parseResult(result);
  } catch (error) {
    // å¤±è´¥åé™çº§
    return this.simpleClassify(notes);
  }
}
```

### 6. ç¦»çº¿å­˜å‚¨ç®¡ç† (StorageManager.ts)

#### IndexedDB æ•°æ®åº“è®¾è®¡

```
Database: epub-reader-db (v1)
    â”œâ”€ ObjectStore: highlights
    â”‚   â”œâ”€ key: id (string)
    â”‚   â”œâ”€ indexes:
    â”‚   â”‚   â”œâ”€ by-book (bookId)
    â”‚   â”‚   â”œâ”€ by-chapter (chapterId)
    â”‚   â”‚   â””â”€ by-date (createdAt)
    â”‚   â””â”€ å®¹é‡: 100,000+ æ¡
    â”‚
    â”œâ”€ ObjectStore: notes
    â”‚   â”œâ”€ key: id (string)
    â”‚   â”œâ”€ indexes:
    â”‚   â”‚   â”œâ”€ by-book (bookId)
    â”‚   â”‚   â”œâ”€ by-date (createdAt)
    â”‚   â”‚   â””â”€ by-tag (tags, multiEntry)
    â”‚   â””â”€ å®¹é‡: 50,000+ æ¡
    â”‚
    â””â”€ ObjectStore: books
        â”œâ”€ key: id (string)
        â”œâ”€ indexes:
        â”‚   â””â”€ by-date (lastReadAt)
        â””â”€ å®¹é‡: 1,000+ æ¡
```

#### æŸ¥è¯¢æ€§èƒ½ä¼˜åŒ–

**ç´¢å¼•ä½¿ç”¨**
```typescript
// ä½¿ç”¨ç´¢å¼•æŸ¥è¯¢ï¼ˆå¿«é€Ÿï¼‰
async getHighlightsByBook(bookId: string) {
  const index = tx.store.index('by-book');
  return await index.getAll(bookId); // ~10ms
}

// å…¨è¡¨æ‰«æï¼ˆæ…¢ï¼‰
async searchHighlights(query: string) {
  const all = await tx.store.getAll(); // ~100ms for 10k records
  return all.filter(h => h.text.includes(query));
}
```

**æ‰¹é‡æ“ä½œ**
```typescript
// æ‰¹é‡å†™å…¥ï¼ˆå•æ¬¡äº‹åŠ¡ï¼‰
async batchSaveHighlights(highlights: Highlight[]) {
  const tx = db.transaction('highlights', 'readwrite');
  
  // å¹¶è¡Œå†™å…¥
  await Promise.all(
    highlights.map(h => tx.store.put(h))
  );
  
  await tx.done; // æäº¤äº‹åŠ¡
}
```

## æ•°æ®æµ

### é˜…è¯»æµç¨‹

```
ç”¨æˆ·åŠ è½½ EPUB
    â†“
EpubParser.load()
    â”œâ†’ è§£ææ–‡ä»¶ç»“æ„
    â”œâ†’ æå–å…ƒæ•°æ®
    â””â†’ è·å–ç« èŠ‚åˆ—è¡¨
    â†“
æ˜¾ç¤ºç›®å½•
    â†“
ç”¨æˆ·ç‚¹å‡»ç« èŠ‚
    â†“
EpubParser.loadChapter()
    â”œâ†’ æ£€æŸ¥ç¼“å­˜
    â”œâ†’ ä» ZIP æå–
    â””â†’ è¿”å› HTML å†…å®¹
    â†“
æ¸²æŸ“å†…å®¹
    â†“
åŠ è½½å·²ä¿å­˜çš„åˆ’çº¿
    â”œâ†’ StorageManager.getHighlightsByChapter()
    â””â†’ VirtualHighlightRenderer.setHighlights()
    â†“
ç”¨æˆ·é˜…è¯» & äº¤äº’
```

### åˆ’çº¿åˆ›å»ºæµç¨‹

```
ç”¨æˆ·é€‰ä¸­æ–‡æœ¬
    â†“
handleTextSelection()
    â†“
HighlightSystem.createHighlight()
    â”œâ†’ ç”Ÿæˆ CFI
    â”œâ†’ æå–è¯­ä¹‰ä¸Šä¸‹æ–‡
    â”œâ†’ è®¡ç®—æ–‡æœ¬åç§»
    â””â†’ åˆ›å»º Highlight å¯¹è±¡
    â†“
VirtualHighlightRenderer.renderSingleHighlight()
    â”œâ†’ æ¢å¤ Range
    â””â†’ åº”ç”¨æ ·å¼
    â†“
StorageManager.saveHighlight()
    â””â†’ ä¿å­˜åˆ° IndexedDB
```

### AI åˆ†ææµç¨‹

```
ç”¨æˆ·ç‚¹å‡» "AI åˆ†æ"
    â†“
AIAssistant.analyzeContent()
    â†“
å¹¶è¡Œæ‰§è¡Œ
    â”œâ†’ generateSummary() [qwen-plus]
    â”œâ†’ generateInsights() [qwen-plus]
    â””â†’ generateQuestions() [qwen-plus]
    â†“
ä¸²è¡Œæ‰§è¡Œ
    â””â†’ generateConnections() [qwen-max]
        â””â†’ åŸºäºå‰é¢çš„ç»“æœ
    â†“
ç»„åˆç»“æœ
    â””â†’ AIAnalysis å¯¹è±¡
    â†“
æ˜¾ç¤ºå¼¹çª—
```

## æ€§èƒ½ä¼˜åŒ–æ€»ç»“

### å†…å­˜ä¼˜åŒ–

1. **æµå¼åŠ è½½** - ç« èŠ‚æŒ‰éœ€åŠ è½½ï¼Œæœ€å¤šç¼“å­˜ 10 ä¸ª
2. **è™šæ‹Ÿæ»šåŠ¨** - åªæ¸²æŸ“å¯è§åŒºåŸŸçš„åˆ’çº¿
3. **èµ„æºé‡Šæ”¾** - ç»„ä»¶å¸è½½æ—¶æ¸…ç†èµ„æº

### æ¸²æŸ“ä¼˜åŒ–

1. **RAFï¼ˆRequestAnimationFrameï¼‰** - ä¸æµè§ˆå™¨åˆ·æ–°åŒæ­¥
2. **æ‰¹é‡æ¸²æŸ“** - æ¯å¸§ 8ms é™åˆ¶ï¼Œé¿å…é˜»å¡
3. **èŠ‚æµé˜²æŠ–** - æ»šåŠ¨äº‹ä»¶ 16ms èŠ‚æµ

### ç½‘ç»œä¼˜åŒ–

1. **HTTP Range Requests** - è¿œç¨‹æ–‡ä»¶æŒ‰éœ€ä¸‹è½½
2. **é¢„åŠ è½½** - é¢„åŠ è½½å‰åç« èŠ‚
3. **å¹¶è¡Œè¯·æ±‚** - AI åˆ†æå¹¶è¡Œæ‰§è¡Œ

### å­˜å‚¨ä¼˜åŒ–

1. **ç´¢å¼•æŸ¥è¯¢** - IndexedDB ä½¿ç”¨ç´¢å¼•
2. **æ‰¹é‡æ“ä½œ** - å•æ¬¡äº‹åŠ¡æ‰¹é‡å†™å…¥
3. **æ•°æ®å‹ç¼©** - è€ƒè™‘ä½¿ç”¨ CompressionStreamï¼ˆæœªæ¥ï¼‰

## å®‰å…¨è€ƒè™‘

1. **XSS é˜²æŠ¤** - ä½¿ç”¨ `dangerouslySetInnerHTML` æ—¶æ¸…ç† HTML
2. **API Key ä¿æŠ¤** - ç¯å¢ƒå˜é‡ + localStorage
3. **CSP ç­–ç•¥** - å†…å®¹å®‰å…¨ç­–ç•¥é…ç½®
4. **æ•°æ®åŠ å¯†** - æ•æ„Ÿæ•°æ®åŠ å¯†å­˜å‚¨ï¼ˆè®¡åˆ’ä¸­ï¼‰

## æ‰©å±•æ€§è®¾è®¡

### æ’ä»¶ç³»ç»Ÿï¼ˆè®¡åˆ’ä¸­ï¼‰

```typescript
interface Plugin {
  name: string;
  version: string;
  onLoad: () => void;
  onUnload: () => void;
  hooks: {
    beforeChapterLoad?: (chapter: EpubChapter) => void;
    afterChapterLoad?: (content: string) => string;
    onHighlightCreate?: (highlight: Highlight) => void;
  };
}
```

### ä¸»é¢˜ç³»ç»Ÿï¼ˆè®¡åˆ’ä¸­ï¼‰

```typescript
interface Theme {
  name: string;
  colors: {
    primary: string;
    background: string;
    text: string;
    // ...
  };
  fonts: {
    body: string;
    heading: string;
  };
}
```

---

**æœ€åæ›´æ–°**: 2025-01-08
**ç‰ˆæœ¬**: 1.0.0

